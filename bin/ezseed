#!/usr/bin/env node

var pkg = require('../package')
  , program = require('../cli/helpers/mnomnom')(require('nomnom'), '')
  , config
  , p = require('path')
  , helper = require('../cli/helpers/promise')

var i18n = require('i18n').configure({
  locales:['en', 'fr'],
  defaultLocale: 'en',
  directory: p.resolve(__dirname, '..', 'locales')
})

//Detect first launch
try {
  config = require('../config/config')

  if(process.env.EZSEED_ENV == 'install') {
    helper.exit('npm install')(0)
  }
} catch(e) {
  var argv = require('minimist')(process.argv.slice(2));
  argv.new = true
  return require('../cli/install')(argv)
}

i18n = require('i18n')
i18n.setLocale(config.lang)

var daemon = function(command) {
  return function(opts) {
    console.log(opts)
  }
}

program.options({
  version: {
    flag: true,
    abbr: 'v',
    callback: function() {
       return pkg.version;
    }
  },
  quiet: {
    flag: true,
    abbr: 'q'
  }
})

program
  .commands('start stop restart')
  .callback(daemon)
  .options({
    rtorrent: {
      help: "rtorrent",
      abbr: "r",
      flag: true
    },
    transmission: {
      abbr: 't',
      help: "transmission",
      flag: true
    },
    user: {
      abbr: 'u',
      help: 'Specify user to restart (if not specified we restart all of them)'
    }
  })
  .help('the ezseed daemon (or specified daemon watcher, ezseed, rtorrent, transmission)')

program
  .commands('rtorrent transmission')
  .callback(daemon)
  .options({
    'user': {
      abbr: 'u',
      help: 'Specify user to restart (if not specified we restart all of them)'
    }
  })

program
  .command('install')
  .option('client', {
    position: 1,
    help: "Client to install"
  })
  .option('skipserver', {
    flag: true,
    help: "Skip server installation"
  })
  .option('skipclient', {
    flag: true,
    help: "Skip client installation"
  })
  .option('skipadmin', {
    flag: true,
    help: "Skip admin creation"
  })
  .option('skipconfig', {
    flag: true,
    help: "Skip config creation"
  })
  .option('force', {
    flag: true,
    help: "Force"
  })
  .callback(function(opts) {

    if(opts.client === undefined) {
      return require('../cli/install')(opts)
    } else if(opts.client == 'rtorrent' || opts.client == 'transmission'){
      require('../cli/commands/install').client(opts.client)()
      .then(helper.exit(i18n.__('Client installation')))
      .catch(helper.exit(i18n.__('Client installation')))
    } else {
      helper.exit(opts.client + i18n.__(' is not a valid entry for client, install'))(1)
    }
  })

program
  .command('config')
  .callback(function() {
    return require('../cli/install')({skipserver: true, skipadmin: true, skipclient: true})
  })

program
  .command('backup')
    .option('path', {
      abbr: 'p',
      default: __dirname + '/backup',
      help: "Backup path"
   })
  .callback()

// program
//   .command('reboot')
//   .callback()

program
  .command('update')
  .callback()

program
  .command('credits')
  .callback(function() {

  })

// program.nocommand().callback(  )

program.parse()

/*
if no args, display menu
else parse args

commands :
Usage: ezseed [options] [command]

  Commands:

	autocheck if it's first start + make some configuration

    start|stop|restart [options] [name]		the ezseed daemon (or specified damon watcher, ezseed, rtorrent, transmission)
    rtorrent|transmission [options]     	<start|stop|restart> (-u user)

    install [options] [client] Install ezseed or the specified client
	update - same

	config

    useradd [options] <rutorrent|transmission|aucun> <username> Adds a user to ezseed and to the system using the specified client
    userdel <username>     /!\ All files will be deleted
	  passwd <username>

    backup                 Backup
    restore [options]      Restore backup config

    credits                Credits

    rtorrent [options] <start|stop|restart> stop rtorrent daemon(s)
    transmission [options] <start|stop|restart> start|stop|restart transmission daemon(s)
    reboot                 Restart all daemons
    deploy                 Deploy ezseed
    configure [options]    Configure

    -v verbose shell commands
    -q quiet

    *

*/
